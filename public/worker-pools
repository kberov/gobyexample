<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Go в примери: Работилници</title>
    <link rel=stylesheet href="site.css">
  </head>
  <script>
      window.onkeydown = (e) => {
          if (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey) {
              return;
          }
          
          if (e.key == "ArrowLeft") {
              window.location.href = 'tickers';
          }
          
          
          if (e.key == "ArrowRight") {
              window.location.href = 'waitgroups';
          }
          
      }
  </script>
  <body>
    <div class="example" id="worker-pools">
      <h2><a href="./">Go в примери</a>: Работилници</h2>
      
      <table>
        
        <tr>
          <td class="docs">
            <p>В този пример ще видим как се осъществява <em>работилница</em>
с помощта на гозадачи и канали.</p>

          </td>
          <td class="code empty leading">
            
          
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            <a href="https://go.dev/play/p/zuFuqtpxzbF"><img title="Run code" src="play.png" class="run" /></a><img title="Copy code" src="clipboard.png" class="copy" />
          <pre class="chroma"><code><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span></span></span></code></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma"><code><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>Ето я заготовката за работник, от която ще създадем
няколко съработни<sup class="footnote-ref" id="fnref:concurrent"><a href="#fn:concurrent">1</a></sup> единици<sup class="footnote-ref" id="fnref:instance"><a href="#fn:instance">2</a></sup>.
Тези работници ще получават работа, по канала <code>работа</code>
и ще изпращат произведенията си по канала
<code>произведено</code>. Ще накараме всяка гозадача да заспи за
секунда, за да наподобим времеемка, сиреч скъпоструваща
задача.</p>

<div class="footnotes">

<hr />

<ol>
<li id="fn:concurrent">concurrent – съработен, едновременно работещ (буквално: съ-бягащ, от con (съ) + фр. courrir), съревновател, състезател</li>

<li id="fn:instance">instance – единица, инстанция</li>
</ol>

</div>

          </td>
          <td class="code leading">
            
          <pre class="chroma"><code><span class="line"><span class="cl"><span class="kd">func</span> <span class="nx">работник</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">работа</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">произведено</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">работа</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;работник&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;започна задача&#34;</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;работник&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;завърши задача&#34;</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">произведено</span> <span class="o">&lt;-</span> <span class="nx">j</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code leading">
            
          <pre class="chroma"><code><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span></span></span></code></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>За да ползваме нашата работилница с работници,
трябва да им изпратим задачи и да съберем
произведенето от всеки работник. За целта правим
(<code>make</code>) два канала.</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma"><code><span class="line"><span class="cl">    <span class="kd">const</span> <span class="nx">бройЗадачи</span> <span class="p">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">    <span class="nx">задачи</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">бройЗадачи</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">произведено</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">бройЗадачи</span><span class="p">)</span></span></span></code></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>Тук създаваме три работника, които в началото не
работят, защото все още нямат задачи.</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma"><code><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">w</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">w</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">w</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">работник</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">задачи</span><span class="p">,</span> <span class="nx">произведено</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>Тук изпращаме пет <code>задачи</code> и после затваряме с
помощта на <code>close</code> канала, за да кажем, че това е
всичко, което искаме да се изработи.</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma"><code><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="nx">бройЗадачи</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">задачи</span> <span class="o">&lt;-</span> <span class="nx">j</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">close</span><span class="p">(</span><span class="nx">задачи</span><span class="p">)</span></span></span></code></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            <p>Накрая събираме всичко произведено. Това изявление
също така обезпечава приключването на всички
гозадачи-работници. Иначе програмата би завършила
без да чака работниците. Друг начин да чакаме
множество гозадачи е като си създадем
чакалня[^wgroup] с помощта на
<a href="waitgroups">WaitGroup</a>. [^wgroup]: wait-group –
(за целите на превода) чакалня, иначе – изчакване
на множество гозадачи.</p>

          </td>
          <td class="code">
            
          <pre class="chroma"><code><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">a</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">a</span> <span class="o">&lt;=</span> <span class="nx">бройЗадачи</span><span class="p">;</span> <span class="nx">a</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">произведение</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">произведено</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Произведено:&#34;</span><span class="p">,</span> <span class="nx">произведение</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
          </td>
        </tr>
        
      </table>
      
      <table>
        
        <tr>
          <td class="docs">
            <p>Работещата ни програма показва, че петте задачи биват
извършвани от различни работници Програмата се изпълнява
само за 2 секунди и нещо, макар всяка задача да отнема
по секунда и нещо. За 2 секунди е свършена работа,
отнемаща общо над 5 секунди, защото трите работника
работеха едновременно.</p>

          </td>
          <td class="code leading">
            
          <pre class="chroma"><code><span class="line"><span class="cl"><span class="gp">$</span> time go run worker-pools.go
</span></span><span class="line"><span class="cl"><span class="go">работник 3 започна задача 1
</span></span></span><span class="line"><span class="cl"><span class="go">работник 1 започна задача 2
</span></span></span><span class="line"><span class="cl"><span class="go">работник 2 започна задача 3
</span></span></span><span class="line"><span class="cl"><span class="go">работник 2 завърши задача 3
</span></span></span><span class="line"><span class="cl"><span class="go">работник 2 започна задача 4
</span></span></span><span class="line"><span class="cl"><span class="go">Произведено: 6
</span></span></span><span class="line"><span class="cl"><span class="go">работник 1 завърши задача 2
</span></span></span><span class="line"><span class="cl"><span class="go">работник 1 започна задача 5
</span></span></span><span class="line"><span class="cl"><span class="go">Произведено: 4
</span></span></span><span class="line"><span class="cl"><span class="go">работник 3 завърши задача 1
</span></span></span><span class="line"><span class="cl"><span class="go">Произведено: 2
</span></span></span><span class="line"><span class="cl"><span class="go">работник 1 завърши задача 5
</span></span></span><span class="line"><span class="cl"><span class="go">Произведено: 10
</span></span></span><span class="line"><span class="cl"><span class="go">работник 2 завърши задача 4
</span></span></span><span class="line"><span class="cl"><span class="go">Произведено: 8</span></span></span></code></pre>
          </td>
        </tr>
        
        <tr>
          <td class="docs">
            
          </td>
          <td class="code">
            
          <pre class="chroma"><code><span class="line"><span class="cl"><span class="go">real    0m2,232s</span></span></span></code></pre>
          </td>
        </tr>
        
      </table>
      
      
      <p class="next">
        Следващ пример: <a href="waitgroups" rel="next">Чакални</a>.
      </p>
      

    <p class="footer">
      от <a href="https://markmcgranaghan.com">Марк Макгранахан</a> и <a href="https://eli.thegreenplace.net">Ели Бендерски</a> | <a href="https://github.com/mmcgrana/gobyexample">изходен код</a> | <a href="https://github.com/mmcgrana/gobyexample#license">разрешително</a>
    </p>

    </div>
    <script>
      var codeLines = [];
      codeLines.push('');codeLines.push('package main\u000A');codeLines.push('import (\u000A    \"fmt\"\u000A    \"time\"\u000A)\u000A');codeLines.push('func работник(id int,\u000A    работа \u003C-chan int, произведено chan\u003C- int) {\u000A    for j :\u003D range работа {\u000A        fmt.Println(\"работник\", id, \"започна задача\", j)\u000A        time.Sleep(time.Second)\u000A        fmt.Println(\"работник\", id, \"завърши задача\", j)\u000A        произведено \u003C- j * 2\u000A    }\u000A}\u000A');codeLines.push('func main() {\u000A');codeLines.push('    const бройЗадачи \u003D 5\u000A    задачи :\u003D make(chan int, бройЗадачи)\u000A    произведено :\u003D make(chan int, бройЗадачи)\u000A');codeLines.push('    for w :\u003D 1; w \u003C\u003D 3; w++ {\u000A        go работник(w, задачи, произведено)\u000A    }\u000A');codeLines.push('    for j :\u003D 1; j \u003C\u003D бройЗадачи; j++ {\u000A        задачи \u003C- j\u000A    }\u000A    close(задачи)\u000A');codeLines.push('    for a :\u003D 1; a \u003C\u003D бройЗадачи; a++ {\u000A        произведение :\u003D \u003C-произведено\u000A        fmt.Println(\"Произведено:\", произведение)\u000A    }\u000A}\u000A');codeLines.push('');codeLines.push('');
    </script>
    <script src="site.js" async></script>
  </body>
</html>
